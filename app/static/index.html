<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Signaler PRO — Bybit</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --chip:#1f2937; --border:#1f2937; --tableStripe:rgba(255,255,255,.02); }
    [data-theme="light"]{ --bg:#f6f7fb; --card:#fff; --muted:#4b5563; --text:#0f172a; --accent:#2563eb; --ok:#16a34a; --warn:#d97706; --err:#dc2626; --chip:#f1f5f9; --border:#e5e7eb; --tableStripe:#f8fafc; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Heebo,"Noto Sans Hebrew",Arial}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.18)}
    h1{font-size:22px;margin:0 0 12px;display:flex;align-items:center;gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,button,select{font:inherit}
    input[type=text],input[type=number]{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--chip);color:var(--text);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.success{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.ghost{background:transparent}

    table{width:100%;border-collapse:separate;border-spacing:0;direction:rtl}
    thead th{font-weight:600;text-align:right;padding:12px;border-bottom:1px solid var(--border);color:var(--muted)}
    tbody td{padding:10px;border-bottom:1px dashed var(--border);vertical-align:top}
    tbody tr:nth-child(odd){background:var(--tableStripe)}

    .pill{display:inline-block;background:var(--chip);border:1px solid var(--border);padding:2px 8px;border-radius:999px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:600}
    .chip.buy{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.3);color:var(--ok)}
    .chip.sell{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.3);color:var(--err)}
    .chip.neutral{color:var(--muted)}

    .reasons{display:flex;flex-direction:column;gap:8px}
    .reason{background:var(--chip);border:1px solid var(--border);border-radius:10px;padding:8px}
    .reason-head{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .reason-name{font-weight:700}
    .reason-meta{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    @media(max-width:900px){.col-6{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Crypto Signaler PRO — Bybit</h1>

    <div class="card">
      <div class="row" style="gap:8px;margin-bottom:12px">
        <button id="btnPersist" class="btn success">שמור (Persist)</button>
        <button id="btnUpdateOnly" class="btn">עדכן לזמן ריצה בלבד</button>
        <button id="btnRefreshSignals" class="btn primary">רענן סיגנלים</button>
      </div>
      <div class="row">
        <div style="flex:1;min-width:220px"><label>Symbol</label><input id="symbol" type="text" value="BTCUSDT" /></div>
        <div style="flex:1;min-width:220px"><label>Timeframes (CSV)</label><input id="timeframes" type="text" value="15m,1h,4h,d,w" /></div>
        <div style="flex:1;min-width:220px"><label>Risk-Reward</label><input id="riskReward" type="number" step="0.1" min="0.5" max="10" value="3" /></div>
        <div style="flex:1;min-width:220px"><label>Decision Threshold</label><input id="decisionThreshold" type="number" step="0.1" min="0.5" max="5" value="1.5" /></div>
        <div style="flex:1;min-width:220px"><label>EMA (fast,mid,slow)</label><input id="ema" type="text" value="35,75,200" /></div>
        <div style="flex:1;min-width:220px"><label>MACD (fast,slow,signal)</label><input id="macd" type="text" value="33,55,55" /></div>
        <div style="flex:1;min-width:220px"><label>StochRSI (rsi,stoch,k,d)</label><input id="stoch" type="text" value="14,25,7,7" /></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">סיגנלים לפי טיים־פריים</div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:40%">Reasons</th>
            <th>Confidence</th>
            <th>Target</th>
            <th>Entry</th>
            <th>Side</th>
            <th style="width:9rem">Timeframe</th>
          </tr>
        </thead>
        <tbody id="signalsBody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Fib 0.31 + הצעת כניסה</div>
        <div class="row" style="gap:8px">
          <label style="align-self:center">TF</label>
          <select id="fibTf" class="btn">
            <option>15m</option><option>1h</option><option selected>4h</option><option>d</option><option>w</option>
          </select>
          <button id="btnRefreshFib" class="btn primary">רענן Fib</button>
        </div>
      </div>

      <div class="grid">
        <div class="col-6">
          <table>
            <thead>
              <tr>
                <th>Direction</th>
                <th>Swing Low</th>
                <th>Swing High</th>
                <th>Level (0.31)</th>
                <th>ATR</th>
                <th>Distance</th>
              </tr>
            </thead>
            <tbody id="fibBody">
              <tr><td colspan="6" class="muted">…</td></tr>
            </tbody>
          </table>
        </div>
        <div class="col-6">
          <table>
            <thead>
              <tr>
                <th>Side</th>
                <th>Entry</th>
                <th>Stop</th>
                <th>Target</th>
                <th>RR</th>
              </tr>
            </thead>
            <tbody id="entryBody">
              <tr><td colspan="5" class="muted">…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Demand / Supply Zones</div>
        <div class="row" style="gap:8px">
          <label style="align-self:center">TF</label>
          <select id="zonesTf" class="btn">
            <option>15m</option><option>1h</option><option selected>4h</option><option>d</option><option>w</option>
          </select>
          <button id="btnRefreshZones" class="btn primary">רענן אזורים</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Demand</th>
            <th>Supply</th>
            <th>ATR</th>
          </tr>
        </thead>
        <tbody id="zonesBody">
          <tr><td colspan="3" class="muted">…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (n, d=3)=> (n==null||isNaN(n))? '-' : Number(n).toLocaleString('en-US',{maximumFractionDigits:d});
    const pct = (x)=> (x==null||isNaN(x))? '0.000%' : (x*100).toFixed(3)+'%';
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '"':'&quot;',
        "'":'&#39;'
      })[m]);
    }
    function sideChip(side){
      side = (side||'NEUTRAL').toUpperCase();
      const cls = side==='BUY'?'buy':(side==='SELL'?'sell':'neutral');
      return `<span class="chip ${cls}">${side}</span>`;
    }
    function sideChipMini(side){
      side = (side||'NEUTRAL').toUpperCase();
      const cls = side==='BUY'?'buy':(side==='SELL'?'sell':'neutral');
      return `<span class="chip ${cls}" style="padding:2px 8px;font-size:12px">${side}</span>`;
    }

    async function loadSettings(){
      const r = await fetch('api/settings',{cache:'no-store'});
      const s = await r.json();
      $('symbol').value = s.symbol || 'BTCUSDT';
      $('timeframes').value = (s.timeframes||['15m','1h','4h','d','w']).join(',');
      $('riskReward').value = s.risk_reward ?? 3;
      $('decisionThreshold').value = s.decision_threshold ?? 1.5;
      $('ema').value = (s.ema||[35,75,200]).join(',');
      $('macd').value = (s.macd||[12,26,9]).join(',');
      $('stoch').value = (s.stoch||[14,14,3,3]).join(',');
    }

    function readSettingsFromUI(){
      return {
        symbol: $('symbol').value.trim().toUpperCase(),
        timeframes: $('timeframes').value.split(',').map(x=>x.trim()).filter(Boolean),
        risk_reward: parseFloat($('riskReward').value),
        decision_threshold: parseFloat($('decisionThreshold').value),
        ema: $('ema').value.split(',').map(x=>parseInt(x.trim(),10)),
        macd: $('macd').value.split(',').map(x=>parseInt(x.trim(),10)),
        stoch: $('stoch').value.split(',').map(x=>parseInt(x.trim(),10)),
      };
    }

    async function saveSettings(persist=true){
      const payload = readSettingsFromUI();
      const r = await fetch('api/settings?persist='+persist,{method:'PUT',headers:{'content-type':'application/json'},body: JSON.stringify(payload)});
      if(!r.ok){ const j = await r.json().catch(()=>({detail:r.statusText})); alert('שגיאה:\n'+(j.detail||r.statusText)); }
    }

    async function fetchOneSignal(tf){
      const s = readSettingsFromUI();
      const url = `api/analyze?symbol=${encodeURIComponent(s.symbol)}&timeframe=${encodeURIComponent(tf)}`;
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) return null;
      return r.json();
    }

    function renderReasons(sig){
      const payload = sig?.signal?.metadata?.reasons ?? sig?.signal?.reasons ?? [];
      const entryFallback = sig?.signal?.entry ?? null;
      if (!Array.isArray(payload) || payload.length === 0) return '<span class="muted">-</span>';

      // Show all indicators, including NEUTRAL
      const objs = (typeof payload[0] === 'string') ? [] : payload;

      if (objs.length === 0) return '<span class="muted">-</span>';

      return '<div class="reasons">' + objs.map(obj => {
        const name = escapeHtml(obj?.name ?? 'Indicator');
        const rationale = escapeHtml(obj?.rationale ?? '');
        const ent = (obj?.entry ?? entryFallback);
        const tgt = obj?.target ?? null;
        const side = obj?.side ?? 'NEUTRAL';
        const conf = (typeof obj?.confidence === 'number') ? obj.confidence.toFixed(3) : '0.000';
        return `<div class="reason">
                  <div class="reason-head">
                    <div class="reason-name">${name}</div>
                    <div>${sideChipMini(side)}</div>
                  </div>
                  <div class="reason-meta">Entry: ${fmt(ent,3)} · Target: ${tgt==null?'-':fmt(tgt,3)} · Conf: ${conf}</div>
                  <div class="reason-meta">${rationale || '-'}</div>
                </div>`;
      }).join('') + '</div>';
    }

    async function refreshSignals(){
      await saveSettings(false).catch(()=>{});
      const s = readSettingsFromUI();
      const body = $('signalsBody');
      body.innerHTML = '';

      for(const tf of s.timeframes){
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="muted">…</td>
          <td class="muted">…</td>
          <td class="muted">…</td>
          <td class="muted">…</td>
          <td class="muted">…</td>
          <td><span class="pill">${tf}</span></td>`;
        body.appendChild(row);

        try{
          const data = await fetchOneSignal(tf);
          const sig = data?.signal || {};
          const conf = pct(sig.confidence);
          const target = sig.target==null? '-' : fmt(sig.target,2);
          const entry  = sig.entry==null? '-' : fmt(sig.entry,2);

          row.children[0].innerHTML = renderReasons(data);
          row.children[1].textContent = conf;
          row.children[2].textContent = target;
          row.children[3].textContent = entry;
          row.children[4].innerHTML = sideChip(sig.side);
        }catch(e){
          row.innerHTML = `<td colspan="6" style="color:red;font-weight:bold">❌ שגיאה בטעינת סיגנלים ל־${tf}</td>`;
          console.error('signal error', tf, e);
        }
      }

      if (!body.children.length){
        const r = document.createElement('tr');
        r.innerHTML = `<td colspan="6" style="text-align:center;color:gray">אין נתונים להצגה</td>`;
        body.appendChild(r);
      }
    }

    async function refreshFib(){
      const symbol = $('symbol').value.trim().toUpperCase();
      const tf = $('fibTf').value;
      const r = await fetch(`api/fib031?symbol=${encodeURIComponent(symbol)}&timeframe=${encodeURIComponent(tf)}`, {cache:'no-store'});
      const j = await r.json().catch(()=>null);

      const fibBody = $('fibBody');
      const entryBody = $('entryBody');
      fibBody.innerHTML = `<tr><td colspan="6" class="muted">—</td></tr>`;
      entryBody.innerHTML = `<tr><td colspan="5" class="muted">—</td></tr>`;

      const fib = j?.fib031;
      const es  = j?.entry_suggestion;

      if(fib){
        fibBody.innerHTML = `
          <tr>
            <td>${sideChip(fib.direction==='up'?'BUY':'SELL')}</td>
            <td>${fmt(fib.swing_low,3)}</td>
            <td>${fmt(fib.swing_high,3)}</td>
            <td>${fmt(fib.level,3)}</td>
            <td>${fmt(fib.atr,2)}</td>
            <td>${fib.distance_pct!=null ? fib.distance_pct.toFixed(3)+'%' : '-'}</td>
          </tr>`;
      }
      if(es){
        entryBody.innerHTML = `
          <tr>
            <td>${sideChip(es.side)}</td>
            <td>${fmt(es.entry,3)}</td>
            <td>${fmt(es.stop,3)}</td>
            <td>${fmt(es.target,3)}</td>
            <td>${fmt(es.rr,2)}</td>
          </tr>`;
      }
    }

    async function refreshZones(){
      const symbol = $('symbol').value.trim().toUpperCase();
      const tf = $('zonesTf').value;
      const r = await fetch(`api/zones?symbol=${encodeURIComponent(symbol)}&timeframe=${encodeURIComponent(tf)}`, {cache:'no-store'});
      const j = await r.json().catch(()=>null);

      const zBody = $('zonesBody');
      zBody.innerHTML = `<tr><td colspan="3" class="muted">—</td></tr>`;

      const z = j?.zones;
      if(z){
        zBody.innerHTML = `
          <tr>
            <td>${fmt(z.demand?.low,3)} – ${fmt(z.demand?.high,3)}</td>
            <td>${fmt(z.supply?.low,3)} – ${fmt(z.supply?.high,3)}</td>
            <td>${fmt(z.atr,2)}</td>
          </tr>`;
      }
    }

    document.getElementById('btnPersist').onclick = ()=> saveSettings(true);
    document.getElementById('btnUpdateOnly').onclick = ()=> saveSettings(false);
    document.getElementById('btnRefreshSignals').onclick = refreshSignals;
    document.getElementById('btnRefreshFib').onclick = refreshFib;
    document.getElementById('btnRefreshZones').onclick = refreshZones;

    window.addEventListener('load', async ()=>{
      await loadSettings();
      await refreshSignals();
      await refreshFib();
      await refreshZones();
    });
  </script>
</body>
</html>